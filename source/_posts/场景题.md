---
title: 场景题
date: 2024-08-25 22:39:28
tags:
categories:
---

# 1. 电商平台中订单未支付过期如何实现自动关单?

业务场景：：外卖订单超 30 分钟未支付，则自动取订单；用户注册成功 15 分钟后，发短信息通知用户等等。

## 1.方案一：**定时任务**

### 1. 定义

写一个定时任务，定期扫描数据库中的订单，如果时间过期，就将其状态更新为关闭即可。

![image-20240825224252447](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240825224252447.png)

### 2. 优点

- 实现容易，成本低，基本不依赖其他组件

### 3. 缺点

- **时间可能不够精确**。由于定时任务扫描的间隔是固定的，所以可能造成一些订单已经过

  期了一段时间才被扫描到，订单关闭的时间比正常时间晚一些。

- **增加了数据库的压力**。随着订单的数量越来越多，扫描的成本也会越来越大，执行时间

  也会被拉长，可能导致某些应该被关闭的订单迟迟没有被关闭。

### 4. 适用场景

对时间要求不是很敏感，并且数据量不太多的业务场景。

## 2. **JDK 延迟队列 DelayQueue**

### 1. 定义

DelayQueue 是 JDK 提供的一个无界队列，我们可以看到，DelayQueue 队列中的元素需要实现 Delayed，它只提供了一个方法，就是获取过期时间用户的订单生成以后，设置过期时间比如 30 分钟，放入定义好的 DelayQueue，然后创建一个线程，在线程中while(true)不断的从 DelayQueue 中获取过期的数据。

### 2. **优点**

不依赖任何第三方组件，连数据库也不需要了，实现起来也方便。

### 3. **缺点**

- DelayQueue 是一个无界队列，如果放入的订单过多，会造成 JVM OOM
- DelayQueue基于 JVM 内存，如果 JVM 重启了，那所有数据就丢失了

### 4. 适用场景

DelayQueue 适用于数据量较小，且丢失也不影响主业务的场景，比如内部系统的一些非重要通知，就算丢失，也不会有太大影响。

## 3. **RocketMQ 延迟消息**

### 1. 定义

### 2. 优点

### 3. 缺点

### 4. 适用场景

## 4. **RabbitMQ 死信队列**

### 1. 定义

### 2. 优点

### 3. 缺点

### 4. 适用场景

## 5. **Redisson 分布式延迟队列**

### 1. 定义

### 2. 优点

### 3. 缺点

### 4. 适用场景

## 6. **redis 过期监听**

### 1. 定义

### 2. 优点

### 3. 缺点

### 4. 适用场景
